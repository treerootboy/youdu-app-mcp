# 多接口 API 集成项目研发方法论（精简版）

## 📋 适用场景

本方法论适用于需要为第三方 API/服务提供多种访问接口（CLI、HTTP API、RPC、SDK 等）的项目。

---

## 🚀 研发流程概览

```
阶段 1: 需求与设计 (20% 时间)
   ├─ 需求澄清 → 输出 REQUIREMENTS.md
   ├─ 技术选型 → 输出 TECH_STACK.md
   └─ 架构设计 → 输出 ARCHITECTURE.md
        ↓
阶段 2: 研发实施 (60% 时间)
   ├─ 任务拆分 → 输出 TASKS.md
   ├─ 迭代开发 → 编码 → 测试 → 审查 → 文档 → 提交
   └─ 持续集成 → CI 自动化
        ↓
阶段 3: 测试验证 (15% 时间)
   ├─ 单元测试 (70%) → Mock 隔离
   ├─ 集成测试 (20%) → Mock Server
   └─ E2E 测试 (10%) → 真实环境
        ↓
阶段 4: 发布交付 (5% 时间)
   ├─ 发布检查 → 质量门禁
   ├─ 创建标签 → 语义化版本
   ├─ 灰度发布 → 5% → 20% → 50% → 100%
   └─ 监控回滚 → 持续监控
```

### 核心原则

1. **架构先行** - 好的架构设计节省 50% 后期重构时间
2. **测试驱动** - 完整的测试是质量保证的基础
3. **文档同步** - 文档与代码同步更新，不能滞后
4. **小步快跑** - 频繁小版本发布，而非大版本一次发布
5. **度量驱动** - 用数据说话（测试覆盖率、性能指标、错误率）

---

## 第一阶段：需求分析与架构设计

### 1.1 需求澄清（关键问题清单）

**业务需求**:
- 需要对接哪个第三方服务？有哪些核心功能？
- 需要提供几种访问方式？（CLI / HTTP API / RPC / SDK 等）
- 目标用户是谁？使用场景是什么？
- 是否需要权限控制？粒度如何？

**非功能需求**:
- 性能要求？（QPS、响应时间）
- 可用性要求？（高可用、容错）
- 安全要求？（认证、加密、审计）
- 可扩展性？（未来是否会新增功能）

**输出物**: `REQUIREMENTS.md`
- 功能列表（按优先级）
- 非功能需求
- 约束条件
- 验收标准

---

### 1.2 技术选型（决策依据）

**编程语言选择**:

| 场景 | 推荐语言 | 理由 |
|------|---------|------|
| 高性能、高并发 | **Go** | 编译型、并发原生支持、部署简单 |
| 快速开发、AI 集成 | **Python** | 生态丰富、开发效率高 |
| 企业级应用 | **Java** | 成熟稳定、Spring 生态完善 |
| 全栈开发 | **TypeScript** | 前后端统一、类型安全 |

**关键依赖选型**:
- CLI 框架：Cobra (Go) / Click (Python) / Picocli (Java)
- HTTP 框架：Chi (Go) / FastAPI (Python) / Spring Boot (Java)
- 配置管理：Viper (Go) / Pydantic (Python) / Spring Config (Java)
- 测试框架：Testify (Go) / pytest (Python) / JUnit (Java)

**输出物**: `TECH_STACK.md`
- 语言和版本
- 核心依赖清单
- 选型理由说明

---

### 1.3 架构设计（分层与模块）

**核心架构模式**: **单一数据源 + 反射自动化**

```
┌─────────────────────────────────────┐
│        接口层（自动生成）            │
│  CLI    HTTP API    RPC    SDK      │
└──────────────┬──────────────────────┘
               │ (反射/代码生成)
┌──────────────▼──────────────────────┐
│         核心业务层 (Adapter)         │
│  • 统一的业务方法定义                │
│  • 类型安全的输入输出                │
│  • 权限检查集成                      │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│           支撑模块层                 │
│  配置管理  权限系统  日志  监控      │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│        第三方 SDK / API              │
└─────────────────────────────────────┘
```

**关键设计决策**:

1. **为什么用单一数据源？**
   - 业务逻辑只定义一次，避免重复
   - 多个接口行为完全一致
   - 修改时只需改一处

2. **如何实现接口自动生成？**
   - 通过**反射**遍历 Adapter 方法
   - 提取方法签名和参数类型
   - 自动注册到各个接口框架

3. **配置化方案**:
   - 配置优先级：`命令行 > 环境变量 > 配置文件 > 默认值`
   - 使用依赖注入而非全局变量（便于测试）
   - 配置验证（启动时检查必填项）

4. **共性功能模块**:
   - **配置管理**: 统一加载和验证
   - **权限系统**: RBAC 模型，配置化
   - **错误处理**: 统一错误码和错误信息
   - **日志系统**: 结构化日志，统一格式
   - **监控指标**: 健康检查、性能指标

**输出物**: `ARCHITECTURE.md`
- 系统架构图
- 模块划分和职责
- 关键设计决策
- 目录结构规范

---

## 第二阶段：研发实施

### 2.1 任务拆分原则

**按层级拆分** (推荐):

```
任务树:
├─ 核心业务层开发 (Adapter)
│  ├─ 用户管理模块
│  ├─ 部门管理模块
│  ├─ 消息管理模块
│  └─ ...
├─ 接口层实现
│  ├─ CLI 自动生成
│  ├─ HTTP API 自动注册
│  └─ RPC 服务注册
├─ 支撑模块
│  ├─ 配置管理
│  ├─ 权限系统
│  └─ 日志系统
└─ 测试和文档
   ├─ 单元测试
   ├─ 集成测试
   └─ 文档编写
```

**任务优先级**:
1. **P0 核心功能**: Adapter 层业务逻辑（关键路径）
2. **P1 必需功能**: 接口生成、配置管理、权限系统
3. **P2 重要功能**: 完整测试、详细文档
4. **P3 可选功能**: 监控、缓存、性能优化

**任务拆分粒度**:
- 单个任务 **≤ 1 天** 完成
- 每个任务有明确的**输入**和**输出**
- 任务之间依赖关系清晰

**输出物**: `TASKS.md` 或项目管理工具
- 任务清单（按优先级）
- 任务依赖关系
- 责任人和截止日期

---

### 2.2 开发标准流程

**单个功能的完整开发流程**:

```
1. 功能设计
   ├─ 明确输入输出
   ├─ 设计数据结构
   └─ 确定依赖关系
        ↓
2. 编写代码
   ├─ 先写接口/类型定义
   ├─ 实现核心逻辑
   └─ 集成到系统
        ↓
3. 编写测试 ⭐
   ├─ 单元测试（必需）
   ├─ Mock 外部依赖
   └─ 验证边界条件
        ↓
4. 本地验证
   ├─ 运行单元测试
   ├─ 手动测试功能
   └─ 检查代码质量
        ↓
5. 代码审查
   ├─ 自查清单
   ├─ 同行评审
   └─ 修改反馈
        ↓
6. 更新文档
   ├─ 代码注释
   ├─ API 文档
   └─ README 更新
        ↓
7. 提交代码
   ├─ 规范的 commit message
   ├─ 推送到分支
   └─ 创建 PR/MR
```

**测试编写原则**:
- **测试先行**（TDD）或**测试同步**（推荐）
- 单元测试覆盖率 **≥ 80%**
- 测试用例包含：正常流程、异常流程、边界条件
- 使用 Mock 隔离外部依赖（数据库、第三方 API）

**文档更新原则**:
- **代码即文档**：充分的代码注释
- **文档同步更新**：代码变更时同步修改文档
- **示例可运行**：文档中的代码示例必须能运行

**代码提交规范**:

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type 类型**:
- `feat`: 新功能
- `fix`: Bug 修复
- `refactor`: 重构（不改变功能）
- `docs`: 文档更新
- `test`: 测试相关
- `chore`: 构建/工具相关

**示例**:
```
feat(adapter): 添加用户管理功能

- 实现 GetUser 方法
- 实现 CreateUser 方法
- 添加相应的单元测试
- 更新 API 文档

Closes #123
```

---

### 2.3 开发阶段检查清单

**功能完成的定义 (DoD - Definition of Done)**:

- [ ] 代码实现完成，通过自测
- [ ] 单元测试编写完成，覆盖率达标
- [ ] 代码审查通过
- [ ] 文档更新完成
- [ ] 集成测试通过
- [ ] 无已知 Bug

**每日站会检查**:
- 昨天完成了什么？
- 今天计划做什么？
- 遇到什么阻碍？

**每周检查**:
- 本周完成的任务数
- 代码提交频率
- 测试覆盖率趋势
- 技术债务情况

---

## 第三阶段：测试验证

### 3.1 测试策略（测试金字塔）

```
        ┌──────────┐
        │ E2E 测试  │ (10%) - 真实环境端到端
        ├──────────┤
        │ 集成测试  │ (20%) - 多模块协同
        ├──────────┤
        │ 单元测试  │ (70%) - 单个函数/方法
        └──────────┘
```

**单元测试**:
- 目标：测试单个函数/方法
- 隔离：Mock 所有外部依赖
- 覆盖：正常、异常、边界

**集成测试**:
- 目标：测试多个模块协同工作
- 环境：使用 Mock Server 模拟外部服务
- 验证：接口行为一致性

**E2E 测试**:
- 目标：真实环境完整流程验证
- 场景：核心业务流程
- 频率：发布前必测

---

### 3.2 测试执行流程

```
本地开发
   ├─ 编写单元测试
   ├─ 运行单元测试
   └─ 代码覆盖率检查
        ↓
提交代码
   ├─ CI 自动运行所有测试
   ├─ 静态代码分析
   └─ 构建二进制文件
        ↓
集成测试环境
   ├─ 部署到测试环境
   ├─ 运行集成测试脚本
   └─ 人工探索性测试
        ↓
预发布环境
   ├─ 运行 E2E 测试
   ├─ 性能测试（如需要）
   └─ 安全扫描
        ↓
生产环境
   ├─ 灰度发布
   ├─ 监控关键指标
   └─ 回滚预案
```

---

## 第四阶段：发布交付

### 4.1 发布前检查清单

**代码质量**:
- [ ] 所有测试通过（单元 + 集成 + E2E）
- [ ] 代码覆盖率达标（≥ 80%）
- [ ] 无严重代码质量问题（通过静态分析）
- [ ] 代码审查完成

**功能完整性**:
- [ ] 所有计划功能已实现
- [ ] 核心功能验证通过
- [ ] 已知 Bug 已修复或记录

**文档完整性**:
- [ ] README 更新
- [ ] API 文档完整
- [ ] CHANGELOG 更新
- [ ] 升级指南（如有破坏性变更）

**安全性**:
- [ ] 敏感信息不在代码中
- [ ] 依赖漏洞扫描通过
- [ ] 安全测试通过（如适用）

---

### 4.2 版本发布流程

#### 1. 确定版本号

遵循语义化版本 (SemVer):

```
主版本.次版本.修订号

v1.2.3
 │  │  └─ 修订号: Bug 修复（向后兼容）
 │  └──── 次版本: 新功能（向后兼容）
 └─────── 主版本: 破坏性变更（不向后兼容）
```

**版本号决策树**:
- 有破坏性 API 变更？ → 主版本 +1
- 新增功能但向后兼容？ → 次版本 +1
- 只是 Bug 修复？ → 修订号 +1

---

#### 2. 准备发布

```bash
# Step 1: 更新 CHANGELOG.md
# 记录本版本的所有变更

# Step 2: 更新版本号
# 在代码中更新版本常量

# Step 3: 最后一次测试
go test ./...

# Step 4: 构建发布版本
go build -o bin/app-v1.2.3 ./cmd/app
```

---

#### 3. 创建 Git 标签

```bash
# 提交所有变更
git add .
git commit -m "chore: release v1.2.3"

# 创建带注释的标签
git tag -a v1.2.3 -m "Release v1.2.3

## 主要变更
- 新增 XXX 功能
- 修复 YYY Bug
- 优化 ZZZ 性能

## 破坏性变更
无

## 升级说明
直接替换二进制文件即可"

# 推送到远程
git push origin main --tags
```

---

#### 4. 发布说明（Release Notes）

在 GitHub/GitLab 创建 Release，包含:

```markdown
# v1.2.3 Release Notes

## 🎉 新增功能
- [Feature A] 新增用户管理功能 (#123)
- [Feature B] 支持批量操作 (#124)

## 🐛 Bug 修复
- [Fix A] 修复并发问题 (#125)
- [Fix B] 修复配置加载错误 (#126)

## 📈 性能优化
- 优化查询性能，提升 50%

## ⚠️ 破坏性变更
无

## 📦 下载
- [Linux x64](link)
- [macOS](link)
- [Windows](link)

## 📚 文档
- [README](link)
- [API 文档](link)
- [升级指南](link)

## 🙏 感谢
感谢所有贡献者...
```

---

#### 5. 部署流程

```
开发环境 ✅
   ↓
测试环境 ✅
   ↓
预发布环境 ✅ (生产数据副本)
   ↓
生产环境（灰度发布）
   ├─ 5% 流量   → 监控 1 小时 ✅
   ├─ 20% 流量  → 监控 2 小时 ✅
   ├─ 50% 流量  → 监控 4 小时 ✅
   └─ 100% 流量 → 持续监控
```

**灰度发布监控指标**:
- 错误率是否上升？
- 响应时间是否正常？
- CPU/内存是否异常？
- 业务指标是否正常？

**回滚预案**:
```bash
# 如果发现问题，立即回滚
kubectl rollout undo deployment/app
# 或
git revert <commit-hash>
git push origin main
```

---

### 4.3 发布后检查

**立即检查**（发布后 1 小时内）:
- [ ] 服务健康检查通过
- [ ] 核心功能验证通过
- [ ] 错误日志无异常
- [ ] 关键业务指标正常

**持续监控**（发布后 24 小时）:
- [ ] 性能指标稳定
- [ ] 错误率在基线内
- [ ] 用户反馈正常
- [ ] 无重大 Bug 报告

**复盘总结**（发布后 1 周）:
- 发布过程顺利吗？
- 遇到什么问题？
- 如何改进？
- 记录到团队知识库

---

## 📊 完整流程总结

```
阶段 1: 需求与设计 (20% 时间)
   ├─ 需求澄清
   ├─ 技术选型
   └─ 架构设计
        ↓
阶段 2: 研发实施 (60% 时间)
   ├─ 任务拆分
   ├─ 迭代开发（编码 → 测试 → 审查 → 文档 → 提交）
   └─ 持续集成
        ↓
阶段 3: 测试验证 (15% 时间)
   ├─ 单元测试
   ├─ 集成测试
   └─ E2E 测试
        ↓
阶段 4: 发布交付 (5% 时间)
   ├─ 发布检查
   ├─ 创建标签
   ├─ 灰度发布
   └─ 监控回滚
```

---

## 💡 关键原则

1. **架构先行**: 好的架构设计节省 50% 后期重构时间
2. **测试驱动**: 完整的测试是质量保证的基础
3. **文档同步**: 文档与代码同步更新，不能滞后
4. **小步快跑**: 频繁小版本发布，而非大版本一次发布
5. **度量驱动**: 用数据说话（测试覆盖率、性能指标、错误率）

---

## 📋 快速检查清单

### 项目启动阶段
- [ ] 需求澄清完成（REQUIREMENTS.md）
- [ ] 技术选型确定（TECH_STACK.md）
- [ ] 架构设计完成（ARCHITECTURE.md）
- [ ] 任务拆分完成（TASKS.md）

### 开发阶段
- [ ] 核心业务层（Adapter）实现完成
- [ ] 接口自动生成实现完成
- [ ] 配置管理实现完成
- [ ] 权限系统实现完成
- [ ] 单元测试覆盖率 ≥ 80%

### 测试阶段
- [ ] 所有单元测试通过
- [ ] 集成测试脚本完成并通过
- [ ] E2E 测试通过
- [ ] Mock Server 实现完成

### 发布阶段
- [ ] 发布前检查清单完成
- [ ] CHANGELOG.md 更新
- [ ] 版本号确定
- [ ] Git 标签创建
- [ ] Release Notes 编写
- [ ] 灰度发布计划制定

---

**文档版本**: v1.0
**创建日期**: 2025-10-17
**适用项目类型**: 多接口 API 集成项目

---

🤖 Generated with [Claude Code](https://claude.com/claude-code)
via [Happy](https://happy.engineering)

Co-Authored-By: Claude <noreply@anthropic.com>
Co-Authored-By: Happy <yesreply@happy.engineering>
